{% extends 'admin/base.html' %}

{% block content %}

<h2 class="text-2xl font-bold mb-5 px-4 sm:px-0 animate-fadeSlide">Temas Solicitados</h2>

<div class="bg-white shadow rounded p-4 overflow-x-auto animate-fade">

    <div class="mb-4 space-y-2">
        {% for message in messages %}
            <div class="px-4 py-2 rounded text-sm transition-all duration-300 transform animate-fadeSlide
                {% if message.tags == 'error' %} bg-red-100 border border-red-400 text-red-700 text-center
                {% elif message.tags == 'success' %} bg-green-100 border border-green-400 text-green-700 text-center
                {% else %} bg-gray-100 border border-gray-400 text-gray-700 {% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    </div>

    <form method="POST" action="{% url 'alterar_status_multiplos' %}">
        {% csrf_token %}

        <div id="acoes-multiplos" class="flex gap-3 mb-4 hidden">
            <button name="acao" value="aprovar"
                class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">
                Aprovar Selecionados
            </button>

            <button name="acao" value="rejeitar"
                class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition">
                Rejeitar Selecionados
            </button>
        </div>

        <table class="hidden md:table w-full border-collapse animate-fadeSlow">
            <thead>
                <tr class="bg-gray-100 border-b border-gray-300">
                    <th class="p-3 text-left text-sm font-semibold text-gray-600">
                        <input type="checkbox" id="selectAll">
                    </th>
                    <th class="p-3 text-left text-sm font-semibold text-gray-600">Nome</th>
                    <th class="p-3 text-left text-sm font-semibold text-gray-600">Curso</th>
                    <th class="p-3 text-left text-sm font-semibold text-gray-600">Título</th>
                    <th class="p-3 text-left text-sm font-semibold text-gray-600">Status (Tutor)</th>
                    <th class="p-3 text-left text-sm font-semibold text-gray-600">Status (Coordenação)</th>
                    <th class="p-3 text-left text-sm font-semibold text-gray-600">Status Final</th>
                    <th class="p-3 text-center text-sm font-semibold text-gray-600">Ações</th>
                </tr>
            </thead>

            <tbody>
                {% for tema in lista_temas_aprovados %}
                <tr class="border-b hover:bg-gray-50 transition-all duration-200 hover:scale-[1.01]">

                    <td class="p-3 text-center">
                        <input type="checkbox" name="temas_selecionados" value="{{ tema.id }}" class="checkbox-item">
                    </td>

                    <td class="p-3 text-sm text-gray-800">{{ tema.estudante.nome }} {{ tema.estudante.sobrenome }}</td>
                    <td class="p-3 text-sm text-gray-800">{{ tema.estudante.curso.nome|default:"—" }}</td>
                    <td class="p-3 text-sm text-gray-800">{{ tema.titulo }}</td>

                    <td class="p-3 text-sm font-semibold">
                        {% if tema.status_tutor == 'pendente' %}
                            <span class="text-yellow-600">Pendente</span>
                        {% elif tema.status_tutor == 'aprovado' %}
                            <span class="text-green-600">Aprovado</span>
                        {% elif tema.status_tutor == 'rejeitado' %}
                            <span class="text-red-600">Rejeitado</span>
                        {% endif %}
                    </td>

                    <td class="p-3 text-sm">
                        {% if tema.status_coordenacao == 'pendente' %}
                            <span class="text-yellow-600 font-semibold">Pendente</span>
                        {% elif tema.status_coordenacao == 'aprovado' %}
                            <span class="text-green-600 font-semibold">Aprovado</span>
                        {% elif tema.status_coordenacao == 'rejeitado' %}
                            <span class="text-red-600 font-semibold">Rejeitado</span>
                        {% endif %}
                    </td>

                    <td class="p-3 text-sm font-medium">{{ tema.status_final|capfirst }}</td>

                    <td class="p-3 text-sm flex items-center justify-center gap-2">
                        {% if request.user.perfil == "cordenacao" %}
                        <a href="{% url 'adicionar_orientador' tema.id %}" 
                           class="px-2 py-1 bg-indigo-600 text-white rounded text-xs hover:bg-indigo-700 transition-all duration-200 hover:scale-105 flex items-center gap-1">
                            <span class="material-icons-sharp text-[14px]">person_add</span> Atribuir
                        </a>
                        {% endif %}

                        <a href="{% url 'alterar_status_tema' tema.id 'aprovado' %}"
                           class="px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700 transition-all duration-200 hover:scale-105">
                            Aprovar
                        </a>

                        <a href="{% url 'alterar_status_tema' tema.id 'rejeitado' %}"
                           class="px-2 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700 transition-all duration-200 hover:scale-105">
                            Rejeitar
                        </a>
                    </td>

                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="md:hidden space-y-4 mt-4 animate-fade">
            {% for tema in lista_temas_aprovados %}
            <div class="border border-gray-200 rounded-lg p-4 bg-gray-50 shadow-sm">
                
                <label class="flex items-center gap-2 mb-2">
                    <input type="checkbox" name="temas_selecionados" value="{{ tema.id }}" class="checkbox-item">
                    <span class="font-semibold text-sm">Selecionar este tema</span>
                </label>

                <div class="flex items-center justify-between mb-2 pb-2 border-b border-gray-200">
                    <span class="text-lg font-bold text-gray-900">{{ tema.estudante.nome }} {{ tema.estudante.sobrenome }}</span>
                    <span class="text-xs font-medium text-blue-600 bg-blue-100 px-2 py-1 rounded-full">
                        {{ tema.estudante.curso.nome|default:"Sem Curso" }}
                    </span>
                </div>

                <div class="space-y-2 text-sm text-gray-700 mb-4">
                    <div><span class="font-semibold">Título:</span> {{ tema.titulo }}</div>
                    <div>
                        <span class="font-semibold">Status Final:</span> 
                        <span class="font-medium {% if tema.status_final == 'aprovado' %}text-green-600{% else %}text-gray-600{% endif %}">
                            {{ tema.status_final|capfirst }}
                        </span>
                    </div>
                </div>

                <div class="flex flex-col gap-2">
                    {% if request.user.perfil == "cordenacao" %}
                    <a href="{% url 'adicionar_orientador' tema.id %}" 
                       class="w-full text-center bg-indigo-600 text-white text-xs py-2 rounded font-bold hover:bg-indigo-700 flex items-center justify-center gap-2">
                       <span class="material-icons-sharp text-sm">person_add</span> ATRIBUIR ORIENTADOR
                    </a>
                    {% endif %}

                    <div class="flex gap-2">
                        <a href="{% url 'alterar_status_tema' tema.id 'aprovado' %}"
                           class="flex-1 text-center bg-green-600 text-white text-xs py-2 rounded hover:bg-green-700">
                            Aprovar
                        </a>

                        <a href="{% url 'alterar_status_tema' tema.id 'rejeitado' %}"
                           class="flex-1 text-center bg-red-600 text-white text-xs py-2 rounded hover:bg-red-700">
                            Rejeitar
                        </a>
                    </div>
                </div>

            </div>
            {% endfor %}
        </div>

    </form>
</div>

<script>
    const selectAll = document.getElementById("selectAll");
    const checkboxes = document.querySelectorAll(".checkbox-item");
    const acoes = document.getElementById("acoes-multiplos");

    function toggleAcoes() {
        const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
        acoes.classList.toggle("hidden", !anyChecked);
    }

    checkboxes.forEach(cb => cb.addEventListener("change", toggleAcoes));
    selectAll?.addEventListener("change", () => {
        checkboxes.forEach(cb => cb.checked = selectAll.checked);
        toggleAcoes();
    });
</script>

{% endblock %}