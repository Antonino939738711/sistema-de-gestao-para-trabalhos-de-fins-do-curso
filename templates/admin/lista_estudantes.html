{% extends 'admin/base.html' %}

{% block content %}

<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 px-4 sm:px-0">
  <div>
    {% if request.user.is_staff %}
    <h2 class="text-2xl font-bold text-gray-800">
      Estudantes – Administrador 
    </h2>
    {% else %}
    <h2 class="text-2xl font-bold text-gray-800">
      Estudantes – {{ request.user.perfil }}
    </h2>
    {% endif %}
    
    <p class="text-sm text-gray-500 mt-1">
      Gestão de estudantes, temas e estado académico
    </p>
  </div>
</div>

<div class="bg-white shadow rounded-xl p-4 mb-6">
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
    <input
      type="text"
      id="filterText"
      placeholder="Buscar por nome ou tema..."
      class="w-full rounded-lg border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 text-sm"
    />

    <select id="filterCurso"
      class="w-full rounded-lg border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
      <option value="">Todos os cursos</option>
      {% for estudante in estudantes %}
        {% if estudante.curso %}
          <option value="{{ estudante.curso.nome }}">{{ estudante.curso.nome }}</option>
        {% endif %}
      {% endfor %}
    </select>

    <select id="filterEstado"
      class="w-full rounded-lg border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
      <option value="">Todos os estados</option>
      <option value="activo">Activo</option>
      <option value="desativado">Desativado</option>
    </select>

    <button onclick="resetFilters()"
      class="rounded-lg bg-gray-100 hover:bg-gray-200 text-sm font-semibold p-2">
      Limpar filtros
    </button>
  </div>
</div>

<form method="post" action="{% url 'alterar_estado_multiplos_usuarios' %}">
{% csrf_token %}

<div class="bg-white shadow-lg rounded-xl p-4 overflow-x-auto">

    <table class="hidden md:table w-full border-collapse">
        <thead>
            <tr class="bg-gray-50 border-b">
                <th class="p-3 text-center">
                    <input type="checkbox" class="scale-110"
                      onclick="document.querySelectorAll('.chk').forEach(c => c.checked = this.checked)">
                </th>
                <th class="p-3 text-left text-xs font-semibold uppercase text-gray-500">Estudante</th>
                <th class="p-3 text-left text-xs font-semibold uppercase text-gray-500">Curso</th>
                <th class="p-3 text-left text-xs font-semibold uppercase text-gray-500">Tema</th>
                <th class="p-3 text-left text-xs font-semibold uppercase text-gray-500">Tutor</th>
                <th class="p-3 text-left text-xs font-semibold uppercase text-gray-500">Estado</th>
            </tr>
        </thead>

        <tbody>
        {% for estudante in estudantes %}
        {% with tema=estudante.tema_list.0 %}
        <tr class="border-b hover:bg-gray-50 transition student-row"
            data-nome="{{ estudante.nome }} {{ estudante.sobrenome }}"
            data-curso="{{ estudante.curso.nome|default:'' }}"
            data-tema="{% if tema %}{{ tema.titulo }}{% endif %}"
            data-estado="{{ estudante.estado_user }}">

            <td class="p-3 text-center">
                <input type="checkbox" name="usuarios" value="{{ estudante.id }}" class="chk scale-110">
            </td>

            <td class="p-3 text-sm font-medium text-gray-800">
                {{ estudante.nome }} {{ estudante.sobrenome }}
            </td>

            <td class="p-3 text-sm text-gray-700">
                {{ estudante.curso.nome|default:"—" }}
            </td>

            <td class="p-3 text-sm text-gray-700 truncate max-w-xs">
                {% if tema %}{{ tema.titulo }}{% else %}—{% endif %}
            </td>

            <td class="p-3 text-sm text-gray-700">
                {% if tema and tema.tutor_indicado %}
                    {{ tema.tutor_indicado.nome }}
                {% else %}
                    —
                {% endif %}
            </td>

            <td class="p-3">
                {% if estudante.estado_user == "activo" %}
                <span class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700">Activo</span>
                {% else %}
                <span class="px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700">Desativado</span>
                {% endif %}
            </td>
        </tr>
        {% endwith %}
        {% endfor %}
        </tbody>
    </table>

    <div class="md:hidden space-y-4">
    {% for estudante in estudantes %}
    {% with tema=estudante.tema_list.0 %}
    <div class="rounded-xl border bg-gray-50 p-4 shadow-sm student-card"
         data-nome="{{ estudante.nome }} {{ estudante.sobrenome }}"
         data-curso="{{ estudante.curso.nome|default:'' }}"
         data-tema="{% if tema %}{{ tema.titulo }}{% endif %}"
         data-estado="{{ estudante.estado_user }}">

        <div class="flex justify-between items-center border-b pb-2 mb-2">
            <div>
                <p class="font-semibold text-gray-800">{{ estudante.nome }} {{ estudante.sobrenome }}</p>
                <p class="text-xs text-gray-500">{{ estudante.curso.nome|default:"Curso não definido" }}</p>
            </div>
            <input type="checkbox" name="usuarios" value="{{ estudante.id }}" class="chk scale-110">
        </div>

        <p class="text-sm"><strong>Tema:</strong> {% if tema %}{{ tema.titulo }}{% else %}—{% endif %}</p>
        <p class="text-sm"><strong>Tutor:</strong>
            {% if tema and tema.tutor_indicado %}{{ tema.tutor_indicado.nome }}{% else %}—{% endif %}
        </p>

        <div class="mt-3">
            {% if estudante.estado_user == "activo" %}
            <span class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700">Activo</span>
            {% else %}
            <span class="px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700">Desativado</span>
            {% endif %}
        </div>
    </div>
    {% endwith %}
    {% endfor %}
    </div>

    <div class="mt-6 flex flex-col sm:flex-row gap-3 border-t pt-6">
        <button type="submit" name="acao" value="activar"
            class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition">
            Ativar Selecionados
        </button>

        <button type="submit" name="acao" value="desativar"
            class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition">
            Desativar Selecionados
        </button>
    </div>

</div>
</form>

<script>
const filterText = document.getElementById("filterText");
const filterCurso = document.getElementById("filterCurso");
const filterEstado = document.getElementById("filterEstado");

function applyFilters() {
  const text = filterText.value.toLowerCase();
  const curso = filterCurso.value.toLowerCase();
  const estado = filterEstado.value.toLowerCase();

  document.querySelectorAll(".student-row, .student-card").forEach(el => {
    const nome = el.dataset.nome.toLowerCase();
    const tema = el.dataset.tema.toLowerCase();
    const cursoEl = el.dataset.curso.toLowerCase();
    const estadoEl = el.dataset.estado.toLowerCase();

    const ok =
      (nome.includes(text) || tema.includes(text)) &&
      (!curso || cursoEl === curso) &&
      (!estado || estadoEl === estado);

    el.style.display = ok ? "" : "none";
  });
}

function resetFilters() {
  filterText.value = "";
  filterCurso.value = "";
  filterEstado.value = "";
  applyFilters();
}

filterText.addEventListener("input", applyFilters);
filterCurso.addEventListener("change", applyFilters);
filterEstado.addEventListener("change", applyFilters);
</script>

{% endblock %}