{% extends 'Estudante/base.html' %}
{% load static %}

{% block content %}

<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 px-4 sm:px-0">
  <div>
    <h2 class="text-2xl font-bold text-gray-800">Relatório de Temas</h2>
    <p class="text-sm text-gray-500 mt-1">Consulta geral de projetos, estudantes e recomendações de tutoria.</p>
  </div>
</div>

<div class="bg-white shadow rounded-xl p-4 mb-6">
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">

    <input
      type="text"
      id="filterText"
      placeholder="Buscar por estudante ou tema..."
      class="w-full rounded-lg border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 text-sm"
    />

    <select id="filterCurso"
      class="w-full rounded-lg border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
      <option value="">Todos os cursos</option>
      {% regroup temas by estudante.curso.nome as curso_list %}
      {% for curso in curso_list %}
        <option value="{{ curso.grouper }}">{{ curso.grouper }}</option>
      {% endfor %}
    </select>

    <select id="filterStatus"
      class="w-full rounded-lg border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
      <option value="">Todos os status</option>
      <option value="aprovado">Aprovado</option>
      <option value="pendente">Pendente</option>
      <option value="rejeitado">Rejeitado</option>
    </select>

    <button onclick="resetFilters()"
      class="rounded-lg bg-gray-100 hover:bg-gray-200 text-sm font-semibold py-2 transition-colors">
      Limpar filtros
    </button>

  </div>
</div>

<form method="post" action="">
{% csrf_token %}

<div class="bg-white shadow-lg rounded-xl p-4 overflow-x-auto">

    <table class="hidden md:table w-full border-collapse">
        <thead>
            <tr class="bg-gray-50 border-b">
                <th class="p-3 text-left text-xs font-semibold uppercase text-gray-500">Estudante / Curso</th>
                <th class="p-3 text-left text-xs font-semibold uppercase text-gray-500">Título do Tema</th>
                <th class="p-3 text-center text-xs font-semibold uppercase text-gray-500">Status</th>
                <th class="p-3 text-left text-xs font-semibold uppercase text-gray-500">Última Recomendação</th>
            </tr>
        </thead>

        <tbody>
        {% for tema in temas %}
        <tr class="border-b hover:bg-gray-50 transition tema-row"
            data-nome="{{ tema.estudante.nome }} {{ tema.estudante.sobrenome }}"
            data-curso="{{ tema.estudante.curso.nome|default:'' }}"
            data-tema="{{ tema.titulo }}"
            data-status="{{ tema.status_final }}">

            <td class="p-3">
                <div class="text-sm font-medium text-gray-800">{{ tema.estudante.nome }} {{ tema.estudante.sobrenome }}</div>
                <div class="text-[10px] font-bold text-indigo-500 uppercase">{{ tema.estudante.curso.nome|default:"—" }}</div>
            </td>

            <td class="p-3 text-sm text-gray-700 leading-snug max-w-xs">
                {{ tema.titulo }}
            </td>

            <td class="p-3 text-center">
                <span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider
                    {% if tema.status_final == 'aprovado' %}bg-green-100 text-green-700
                    {% elif tema.status_final == 'rejeitado' %}bg-red-100 text-red-700
                    {% else %}bg-amber-100 text-amber-700{% endif %}">
                    {{ tema.get_status_final_display }}
                </span>
            </td>

            <td class="p-3">
                {% with ultima=tema.recomendacoes.all|first %}
                    {% if ultima %}
                        <div class="text-[11px] text-gray-600 italic line-clamp-1">"{{ ultima.texto }}"</div>
                        <div class="text-[9px] text-gray-400 font-bold uppercase mt-1">Tutor: {{ ultima.tutor.nome }}</div>
                    {% else %}
                        <span class="text-xs text-gray-300">Sem recomendações</span>
                    {% endif %}
                {% endwith %}
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>

    <div class="md:hidden space-y-4">
    {% for tema in temas %}
    <div class="rounded-xl border bg-gray-50 p-4 shadow-sm tema-card"
         data-nome="{{ tema.estudante.nome }} {{ tema.estudante.sobrenome }}"
         data-curso="{{ tema.estudante.curso.nome|default:'' }}"
         data-tema="{{ tema.titulo }}"
         data-status="{{ tema.status_final }}">

        <div class="flex justify-between items-start border-b pb-2 mb-2">
            <div>
                <p class="font-semibold text-gray-800">{{ tema.estudante.nome }} {{ tema.estudante.sobrenome }}</p>
                <p class="text-[10px] font-bold text-indigo-500 uppercase">{{ tema.estudante.curso.nome|default:"Sem curso" }}</p>
            </div>
            <span class="px-2 py-1 rounded-md text-[9px] font-black uppercase
                {% if tema.status_final == 'aprovado' %}bg-green-100 text-green-700
                {% elif tema.status_final == 'rejeitado' %}bg-red-100 text-red-700
                {% else %}bg-amber-100 text-amber-700{% endif %}">
                {{ tema.status_final }}
            </span>
        </div>

        <p class="text-sm text-gray-700 mb-3"><strong>Tema:</strong> {{ tema.titulo }}</p>
        
        {% with ultima=tema.recomendacoes.all|first %}
            {% if ultima %}
            <div class="p-2 bg-white rounded border border-gray-200 text-[11px] text-gray-500 italic">
                <strong>Última Rec:</strong> {{ ultima.texto|truncatechars:80 }}
            </div>
            {% endif %}
        {% endwith %}
    </div>
    {% endfor %}
    </div>

    <div id="noResults" class="hidden text-center py-12">
        <span class="material-icons-sharp text-5xl text-gray-200">manage_search</span>
        <p class="text-gray-500 mt-2 font-medium">Nenhum tema corresponde aos filtros aplicados.</p>
    </div>

</div>
</form>

<script>
const filterText = document.getElementById("filterText");
const filterCurso = document.getElementById("filterCurso");
const filterStatus = document.getElementById("filterStatus");
const noResults = document.getElementById("noResults");

function applyFilters() {
    const text = filterText.value.toLowerCase();
    const curso = filterCurso.value.toLowerCase();
    const status = filterStatus.value.toLowerCase();
    let hasMatch = false;

    document.querySelectorAll(".tema-row, .tema-card").forEach(el => {
        const nome = el.dataset.nome.toLowerCase();
        const tema = el.dataset.tema.toLowerCase();
        const cursoEl = el.dataset.curso.toLowerCase();
        const statusEl = el.dataset.status.toLowerCase();

        const matchText = nome.includes(text) || tema.includes(text);
        const matchCurso = !curso || cursoEl === curso;
        const matchStatus = !status || statusEl === status;

        if (matchText && matchCurso && matchStatus) {
            el.style.display = "";
            hasMatch = true;
        } else {
            el.style.display = "none";
        }
    });

    noResults.classList.toggle("hidden", hasMatch);
    // Esconde o cabeçalho da tabela se não houver resultados (apenas desktop)
    const tableHeader = document.querySelector('thead');
    if(tableHeader) tableHeader.style.display = hasMatch ? "" : "none";
}

function resetFilters() {
    filterText.value = "";
    filterCurso.value = "";
    filterStatus.value = "";
    applyFilters();
}

filterText.addEventListener("input", applyFilters);
filterCurso.addEventListener("change", applyFilters);
filterStatus.addEventListener("change", applyFilters);
</script>

<style>
    .line-clamp-1 {
        display: -webkit-box;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>

{% endblock %}