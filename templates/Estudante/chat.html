{% extends 'Estudante/base.html' %}
{% load static %}

{% block titulo_pagina %}Chat com Tutor{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">

    {% if erro %}
        <p class="text-red-600 font-medium">{{ erro }}</p>
    {% else %}
        <div class="flex flex-col h-[70vh] bg-white shadow rounded overflow-hidden">

            <!-- Lista de mensagens -->
            <div id="mensagens" class="flex-1 p-4 overflow-y-auto bg-gray-50">
                {% for m in mensagens %}
                    <div class="mb-2 flex {% if m.remetente == user %}justify-end{% else %}justify-start{% endif %}">
                        <span class="px-3 py-2 rounded inline-block
                            {% if m.remetente == user %}
                                bg-blue-500 text-white
                            {% else %}
                                bg-gray-300
                            {% endif %}
                        ">
                            {{ m.texto }}
                        </span>
                    </div>
                {% empty %}
                    <p class="text-gray-500">Nenhuma mensagem ainda.</p>
                {% endfor %}
            </div>

            <!-- Campo de envio -->
            <div class="flex p-3 border-t bg-white">
                <input type="hidden" id="destinatario" value="{{ tutor.id }}">
                <input id="texto" type="text" placeholder="Escreve uma mensagem..."
                       class="flex-1 border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                <button onclick="enviar()" class="ml-2 bg-primary text-white px-4 py-2 rounded hover:bg-blue-700">
                    Enviar
                </button>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
function scrollMensagens() {
    const container = document.getElementById("mensagens");
    container.scrollTop = container.scrollHeight;
}

// Scroll inicial
scrollMensagens();

function enviar() {
    const texto = document.getElementById("texto").value.trim();
    const destinatario = document.getElementById("destinatario").value;

    if (!texto) return;

    fetch("{% url 'enviar_mensagem' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/x-www-form-urlencoded",
        },
        body: `texto=${encodeURIComponent(texto)}&destinatario=${destinatario}`
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "ok") {
            document.getElementById("texto").value = "";
            atualizarMensagens();
        }
    });
}

// Função para atualizar mensagens a cada 3s
function atualizarMensagens() {
    fetch("{% url 'chat_estudante' %}")
        .then(res => res.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");
            const novasMensagens = doc.getElementById("mensagens").innerHTML;
            document.getElementById("mensagens").innerHTML = novasMensagens;
            scrollMensagens();
        });
}

// Atualização automática
setInterval(atualizarMensagens, 3000);
</script>
{% endblock %}
